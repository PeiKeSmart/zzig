// ============================================================================
// å¼‚æ­¥æ—¥å¿—é…ç½®æ–‡ä»¶ç¤ºä¾‹
// ============================================================================
// æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨é…ç½®æ–‡ä»¶æ¥ç®¡ç†å¼‚æ­¥æ—¥å¿—å‚æ•°
//
// è¿è¡Œ: zig build config-demo -Doptimize=ReleaseFast
//
// åŠŸèƒ½:
//   1. è‡ªåŠ¨æ£€æµ‹é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
//   2. ä¸å­˜åœ¨åˆ™è‡ªåŠ¨ç”Ÿæˆé»˜è®¤é…ç½®
//   3. ä»é…ç½®æ–‡ä»¶åŠ è½½å‚æ•°åˆå§‹åŒ–æ—¥å¿—å™¨
//   4. æ”¯æŒè¿è¡Œæ—¶è°ƒæ•´é˜Ÿåˆ—å¤§å°ã€æ—¥å¿—çº§åˆ«ç­‰
// ============================================================================

const std = @import("std");
const zzig = @import("zzig");

pub fn main() !void {
    var gpa = std.heap.GeneralPurposeAllocator(.{}){};
    defer _ = gpa.deinit();
    const allocator = gpa.allocator();

    std.debug.print("\n" ++ "=" ** 60 ++ "\n", .{});
    std.debug.print("ğŸš€ å¼‚æ­¥æ—¥å¿—é…ç½®æ–‡ä»¶ç¤ºä¾‹\n", .{});
    std.debug.print("=" ** 60 ++ "\n\n", .{});

    // ========================================================================
    // æ–¹å¼ 1: ä½¿ç”¨é…ç½®æ–‡ä»¶åˆå§‹åŒ– (æ¨èç”Ÿäº§ç¯å¢ƒä½¿ç”¨)
    // ========================================================================
    std.debug.print("ğŸ“Œ æ–¹å¼ 1: ä»é…ç½®æ–‡ä»¶åŠ è½½\n", .{});
    std.debug.print("-" ** 60 ++ "\n", .{});

    const config_path = "logger_config.json";

    // initFromConfigFile ä¼šè‡ªåŠ¨:
    // 1. æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    // 2. ä¸å­˜åœ¨åˆ™ç”Ÿæˆé»˜è®¤é…ç½®
    // 3. åŠ è½½é…ç½®å¹¶æ‰“å°å‚æ•°
    // 4. ä½¿ç”¨é…ç½®åˆå§‹åŒ–æ—¥å¿—å™¨
    var logger = try zzig.AsyncLogger.AsyncLogger.initFromConfigFile(allocator, config_path);
    defer logger.deinit();

    std.debug.print("\nâœ… æ—¥å¿—å™¨å·²å°±ç»ª,å¼€å§‹æµ‹è¯•...\n\n", .{});

    // ========================================================================
    // æµ‹è¯•: å‘é€ä¸åŒçº§åˆ«çš„æ—¥å¿—
    // ========================================================================
    logger.debug("è¿™æ˜¯ DEBUG çº§åˆ«æ—¥å¿— - è°ƒè¯•ä¿¡æ¯", .{});
    logger.info("è¿™æ˜¯ INFO çº§åˆ«æ—¥å¿— - æ™®é€šä¿¡æ¯", .{});
    logger.warn("è¿™æ˜¯ WARN çº§åˆ«æ—¥å¿— - è­¦å‘Šä¿¡æ¯", .{});
    logger.err("è¿™æ˜¯ ERROR çº§åˆ«æ—¥å¿— - é”™è¯¯ä¿¡æ¯", .{});

    // æ¨¡æ‹Ÿä¸šåŠ¡æ“ä½œ
    var i: usize = 0;
    while (i < 100) : (i += 1) {
        logger.info("å¤„ç†ä»»åŠ¡ {d}/100", .{i + 1});

        if (i % 10 == 0) {
            logger.debug("æ£€æŸ¥ç‚¹: å·²å®Œæˆ {d}%", .{i});
        }

        if (i == 42) {
            logger.warn("æ£€æµ‹åˆ°ç‰¹æ®Šæƒ…å†µ: i == 42", .{});
        }
    }

    // ç­‰å¾…æ—¥å¿—å…¨éƒ¨è¾“å‡º
    std.Thread.sleep(100_000_000); // 100ms

    // ========================================================================
    // æ‰“å°ç»Ÿè®¡ä¿¡æ¯
    // ========================================================================
    const stats = logger.getStats();
    std.debug.print("\n" ++ "=" ** 60 ++ "\n", .{});
    std.debug.print("ğŸ“Š è¿è¡Œç»Ÿè®¡:\n", .{});
    std.debug.print("=" ** 60 ++ "\n", .{});
    std.debug.print("  å·²å¤„ç†: {d} æ¡\n", .{stats.processed_count});
    std.debug.print("  å·²ä¸¢å¼ƒ: {d} æ¡\n", .{stats.dropped_count});
    std.debug.print("  é˜Ÿåˆ—å‰©ä½™: {d} æ¡\n", .{stats.queue_size});

    if (stats.processed_count > 0) {
        const drop_rate = @as(f64, @floatFromInt(stats.dropped_count)) /
            @as(f64, @floatFromInt(stats.processed_count + stats.dropped_count)) * 100.0;
        std.debug.print("  ä¸¢å¼ƒç‡: {d:.4}%\n", .{drop_rate});

        if (drop_rate > 10.0) {
            std.debug.print("\nâš ï¸  ä¸¢å¼ƒç‡è¾ƒé«˜,å»ºè®®:\n", .{});
            std.debug.print("   1. å¢å¤§é…ç½®æ–‡ä»¶ä¸­çš„ queue_capacity (å½“å‰å¯èƒ½ä¸è¶³)\n", .{});
            std.debug.print("   2. æé«˜ min_level è¿‡æ»¤ä½çº§åˆ«æ—¥å¿— (å‡å°‘æ—¥å¿—é‡)\n", .{});
            std.debug.print("   3. æ‰¹é‡å‘é€æ—¥å¿—å¹¶æ·»åŠ å»¶è¿Ÿ (é¿å…çªå‘)\n", .{});
        }
    }

    std.debug.print("\n" ++ "=" ** 60 ++ "\n", .{});
    std.debug.print("âœ… ç¤ºä¾‹å®Œæˆ!\n", .{});
    std.debug.print("=" ** 60 ++ "\n\n", .{});

    // ========================================================================
    // é…ç½®æ–‡ä»¶è¯´æ˜
    // ========================================================================
    std.debug.print("ğŸ’¡ é…ç½®æ–‡ä»¶ä½ç½®: {s}\n", .{config_path});
    std.debug.print("ğŸ’¡ ä¿®æ”¹é…ç½®åé‡æ–°è¿è¡Œæœ¬ç¨‹åºå³å¯ç”Ÿæ•ˆ\n", .{});
    std.debug.print("ğŸ’¡ å…³é”®å‚æ•°:\n", .{});
    std.debug.print("   - queue_capacity: é˜Ÿåˆ—å¤§å° (å»ºè®® 8192/16384/32768)\n", .{});
    std.debug.print("   - min_level: æœ€ä½çº§åˆ« (debug/info/warn/err)\n", .{});
    std.debug.print("   - output_target: è¾“å‡ºç›®æ ‡ (console/file/both)\n", .{});
    std.debug.print("   - batch_size: æ‰¹å¤„ç†é‡ (å»ºè®® 50-200)\n", .{});
    std.debug.print("\n", .{});
}
