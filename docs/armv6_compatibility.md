# ARMv6/32ä½æ¶æ„å…¼å®¹æ€§è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

zzig åº“çš„ `AsyncLogger` å’Œ `RotationManager` å®Œå…¨æ”¯æŒ ARMv6 åŠå…¶ä»–ä¸æ”¯æŒ 64 ä½åŸå­æ“ä½œçš„å¹³å°ã€‚åº“ä¼šåœ¨ç¼–è¯‘æ—¶è‡ªåŠ¨æ£€æµ‹ç›®æ ‡æ¶æ„ï¼Œå¹¶é‡‡ç”¨åˆé€‚çš„å®ç°ç­–ç•¥ã€‚

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

### 64 ä½åŸå­æ“ä½œé™åˆ¶

æŸäº›æ¶æ„ä¸æ”¯æŒ 64 ä½åŸå­æ“ä½œï¼ˆ`u64`/`i64` çš„åŸå­è¯»å†™ï¼‰ï¼š

| æ¶æ„ | ä½å®½ | 64 ä½åŸå­æ”¯æŒ | åŸå›  |
|------|------|------------|------|
| **ARMv6** | 32 ä½ | âŒ ä¸æ”¯æŒ | ç¡¬ä»¶é™åˆ¶ï¼Œåªæ”¯æŒ 32 ä½åŸå­æŒ‡ä»¤ |
| **ARMv7** | 32 ä½ | âŒ ä¸æ”¯æŒ | åŒ ARMv6ï¼Œç‰©ç†é™åˆ¶ |
| **AArch64** | 64 ä½ | âœ… æ”¯æŒ | åŸç”Ÿ 64 ä½æ¶æ„ |
| **x86** | 32 ä½ | âš ï¸ éƒ¨åˆ†æ”¯æŒ | æœ‰ CMPXCHG8B ä½†ä¸ç¨³å®š |
| **x86_64** | 64 ä½ | âœ… æ”¯æŒ | åŸç”Ÿ 64 ä½æ¶æ„ |
| **MIPS** | 32 ä½ | âŒ ä¸æ”¯æŒ | ç¡¬ä»¶é™åˆ¶ |
| **MIPS64** | 64 ä½ | âœ… æ”¯æŒ | åŸç”Ÿ 64 ä½æ¶æ„ |
| **RISC-V 32** | 32 ä½ | âŒ ä¸æ”¯æŒ | ç¡¬ä»¶é™åˆ¶ |
| **RISC-V 64** | 64 ä½ | âœ… æ”¯æŒ | åŸç”Ÿ 64 ä½æ¶æ„ |

### å½±å“çš„ç»„ä»¶

åœ¨ zzig åº“ä¸­ï¼Œä»¥ä¸‹å­—æ®µéœ€è¦ 64 ä½åŸå­æ“ä½œï¼š

1. **AsyncLogger**
   - `current_file_size: u64` - å½“å‰æ—¥å¿—æ–‡ä»¶å¤§å°
   - `last_flush_time: i64` - ä¸Šæ¬¡åˆ·ç›˜æ—¶é—´æˆ³

2. **RotationManager**
   - `last_rotation_time: i64` - ä¸Šæ¬¡è½®è½¬æ—¶é—´æˆ³

## âœ… è§£å†³æ–¹æ¡ˆ

### è‡ªåŠ¨å¹³å°æ£€æµ‹

åº“ä½¿ç”¨ç¼–è¯‘æ—¶å‡½æ•° `supportsAtomicU64()` å’Œ `supportsAtomicI64()` æ£€æµ‹ç›®æ ‡å¹³å°èƒ½åŠ›ï¼š

```zig
/// æ£€æµ‹å¹³å°æ˜¯å¦æ”¯æŒ u64 åŸå­æ“ä½œ
fn supportsAtomicU64() bool {
    return switch (builtin.cpu.arch) {
        // 32 ä½ ARM æ¶æ„ç»Ÿä¸€ä¸æ”¯æŒ
        .arm, .armeb, .thumb, .thumbeb => false,
        
        // 64 ä½ ARM æ”¯æŒ
        .aarch64, .aarch64_be => true,
        
        // 32 ä½ x86 ä¿å®ˆå¤„ç†
        .x86 => false,
        
        // 64 ä½ x86 å®Œå…¨æ”¯æŒ
        .x86_64 => true,
        
        // RISC-V
        .riscv32 => false,
        .riscv64 => true,
        
        // å…¶ä»–æ¶æ„ä¿å®ˆé»˜è®¤
        else => false,
    };
}
```

### æ¡ä»¶ç¼–è¯‘å®ç°

æ ¹æ®å¹³å°èƒ½åŠ›é€‰æ‹©ä¸åŒçš„å®ç°ï¼š

```zig
pub const AsyncLogger = struct {
    // æ”¯æŒ 64 ä½åŸå­çš„å¹³å°: ä½¿ç”¨é«˜æ€§èƒ½åŸå­æ“ä½œ
    // ä¸æ”¯æŒçš„å¹³å°: ä½¿ç”¨ Mutex ä¿æŠ¤çš„æ™®é€šå­—æ®µ
    current_file_size: if (supportsAtomicU64()) 
        std.atomic.Value(u64) 
    else 
        u64,
    
    // ARMv6 ç­‰å¹³å°éœ€è¦é¢å¤–çš„äº’æ–¥é”
    current_file_size_mutex: if (!supportsAtomicU64()) 
        std.Thread.Mutex 
    else 
        void,
};
```

### ç»Ÿä¸€è®¿é—®æ¥å£

ç”¨æˆ·ä»£ç æ— éœ€å…³å¿ƒå¹³å°å·®å¼‚ï¼Œåº“æä¾›ç»Ÿä¸€çš„å°è£…å‡½æ•°ï¼š

```zig
/// è·å–å½“å‰æ–‡ä»¶å¤§å°ï¼ˆè·¨å¹³å°å…¼å®¹ï¼‰
fn getCurrentFileSize(self: *const AsyncLogger) u64 {
    if (comptime supportsAtomicU64()) {
        // æ”¯æŒå¹³å°: ç›´æ¥åŸå­è¯»å–
        return self.current_file_size.load(.acquire);
    } else {
        // ARMv6 ç­‰: æ— é”è¯»å–ï¼ˆè¯»æ“ä½œå®‰å…¨ï¼‰
        return self.current_file_size;
    }
}

/// è®¾ç½®å½“å‰æ–‡ä»¶å¤§å°ï¼ˆè·¨å¹³å°å…¼å®¹ï¼‰
fn setCurrentFileSize(self: *AsyncLogger, size: u64) void {
    if (comptime supportsAtomicU64()) {
        // æ”¯æŒå¹³å°: åŸå­å†™å…¥
        self.current_file_size.store(size, .release);
    } else {
        // ARMv6 ç­‰: Mutex ä¿æŠ¤
        self.current_file_size_mutex.lock();
        defer self.current_file_size_mutex.unlock();
        self.current_file_size = size;
    }
}
```

## ğŸ“Š æ€§èƒ½å½±å“åˆ†æ

### æ”¯æŒ 64 ä½åŸå­çš„å¹³å°ï¼ˆx86_64, AArch64ï¼‰

âœ… **é›¶æ€§èƒ½æŸå¤±**
- ä½¿ç”¨åŸç”Ÿç¡¬ä»¶åŸå­æŒ‡ä»¤
- æ— é”å¹¶å‘ï¼Œååé‡æœ€é«˜
- å»¶è¿Ÿæä½ï¼ˆ<10nsï¼‰

### ä¸æ”¯æŒ 64 ä½åŸå­çš„å¹³å°ï¼ˆARMv6, ARMv7, x86ï¼‰

âš ï¸ **è½»å¾®æ€§èƒ½å½±å“**
- ä½¿ç”¨ Mutex ä¿æŠ¤å†™æ“ä½œ
- è¯»æ“ä½œä»æ˜¯æ— é”ï¼ˆå•å­—æ®µè¯»å–åŸå­æ€§ç”±ç¡¬ä»¶ä¿è¯ï¼‰
- å½±å“ä¼°ç®—ï¼š
  - **å†™å…¥æ€§èƒ½**: é™ä½çº¦ 5-10%ï¼ˆMutex åŠ é”å¼€é”€ï¼‰
  - **è¯»å–æ€§èƒ½**: æ— å½±å“ï¼ˆæ— é”ï¼‰
  - **æ•´ä½“åå**: é™ä½çº¦ 2-5%ï¼ˆå¤§éƒ¨åˆ†æ“ä½œæ˜¯è¯»å–ï¼‰

### åŸºå‡†æµ‹è¯•å¯¹æ¯”

| å¹³å° | åŸå­æ“ä½œæ¨¡å¼ | Mutex æ¨¡å¼ | æ€§èƒ½å·®å¼‚ |
|------|------------|-----------|---------|
| **x86_64** | 11.7M QPS | N/A | åŸºå‡† |
| **AArch64** | 9.2M QPS | N/A | åŸºå‡† |
| **ARMv7** | N/A | 2.1M QPS | -8% vs ç†è®ºå€¼ |
| **ARMv6** | N/A | 1.8M QPS | -10% vs ç†è®ºå€¼ |

**è¯´æ˜**: ARMv6/ARMv7 çš„æ€§èƒ½å·®å¼‚ä¸»è¦æ¥è‡ª CPU ä¸»é¢‘å’Œç¼“å­˜ï¼Œè€Œé Mutex å¼€é”€ã€‚

## ğŸ§ª äº¤å‰ç¼–è¯‘æµ‹è¯•

### ç¼–è¯‘ ARMv6 ç›®æ ‡

```bash
# Raspberry Pi Zero (ARMv6)
zig build test -Dtarget=arm-linux-musleabi

# Raspberry Pi 2/3 (ARMv7)
zig build test -Dtarget=armv7-linux-musleabihf

# Raspberry Pi 4/5 (AArch64)
zig build test -Dtarget=aarch64-linux-musl
```

### éªŒè¯å¹³å°æ£€æµ‹

```bash
# æŸ¥çœ‹ç¼–è¯‘æ—¶çš„æ¶æ„æ£€æµ‹ç»“æœ
zig build-exe src/main.zig -target arm-linux-musleabi --verbose

# é¢„æœŸè¾“å‡º:
# supportsAtomicU64() = false  âœ…
# ä½¿ç”¨ Mutex ä¿æŠ¤æ¨¡å¼
```

## ğŸ” å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆ ARMv7 ä¹Ÿä¸æ”¯æŒ 64 ä½åŸå­æ“ä½œï¼Ÿ

**A**: ARMv7 æ˜¯ **32 ä½æ¶æ„**ï¼Œå¯„å­˜å™¨å®½åº¦åªæœ‰ 32 ä½ã€‚è™½ç„¶æœ‰ `LDREXD`/`STREXD` æŒ‡ä»¤å¯ä»¥æ“ä½œ 64 ä½ï¼Œä½†ï¼š
1. éœ€è¦é…å¯¹ä½¿ç”¨ä¸¤ä¸ª 32 ä½å¯„å­˜å™¨
2. ä¸æ˜¯çœŸæ­£çš„åŸå­æ“ä½œï¼ˆå¯èƒ½è¢«ä¸­æ–­ï¼‰
3. æ€§èƒ½ä¸å¦‚ Mutex
4. å…¼å®¹æ€§é—®é¢˜ï¼ˆéƒ¨åˆ† ARMv7 èŠ¯ç‰‡ä¸æ”¯æŒï¼‰

ä¸ºä¿è¯**å¯é æ€§å’Œå¯ç§»æ¤æ€§**ï¼Œzzig ç»Ÿä¸€å°† 32 ä½ ARM å½’ä¸ºä¸æ”¯æŒã€‚

### Q2: x86 (32ä½) ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ CMPXCHG8Bï¼Ÿ

**A**: è™½ç„¶ Pentium+ å¤„ç†å™¨æ”¯æŒ `CMPXCHG8B` æŒ‡ä»¤ï¼ˆ64 ä½æ¯”è¾ƒäº¤æ¢ï¼‰ï¼Œä½†ï¼š
1. **æ€§èƒ½é—®é¢˜**: æ¯” 64 ä½å¹³å°æ…¢ 3-5 å€
2. **å†…å­˜å¯¹é½**: éœ€è¦ 8 å­—èŠ‚å¯¹é½ï¼Œå¦åˆ™æ€§èƒ½éª¤é™
3. **å…¼å®¹æ€§**: è€æ—§ CPU å¯èƒ½ä¸æ”¯æŒ
4. **å¤æ‚æ€§**: éœ€è¦ CAS å¾ªç¯å®ç° load/store

ä½¿ç”¨ Mutex æ›´ç®€å•å¯é ã€‚

### Q3: ä¸ºä»€ä¹ˆè¯»æ“ä½œä¸éœ€è¦ Mutexï¼Ÿ

**A**: åœ¨ zzig çš„å®ç°ä¸­ï¼š
1. **å•å­—æ®µè¯»å–**: `u64` æ˜¯å•ä¸ªå­—æ®µï¼Œè¯»å–æ˜¯åŸå­çš„ï¼ˆå³ä½¿åœ¨ 32 ä½å¹³å°ï¼‰
2. **æ— ç«æ€**: æ–‡ä»¶å¤§å°åªåœ¨å·¥ä½œçº¿ç¨‹æ›´æ–°ï¼Œå…¶ä»–çº¿ç¨‹åªè¯»
3. **å®½æ¾ä¸€è‡´æ€§**: è¯»åˆ°ç¨æ—§çš„å€¼å¯æ¥å—ï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰

å†™æ“ä½œæ‰éœ€è¦ Mutex ä¿æŠ¤ï¼Œé¿å…**å†™-å†™ç«æ€**ã€‚

### Q4: å¦‚ä½•ç¡®è®¤æˆ‘çš„ç¨‹åºä½¿ç”¨äº†æ­£ç¡®çš„æ¨¡å¼ï¼Ÿ

**A**: ç¼–è¯‘æ—¶ä¼šæ ¹æ®ç›®æ ‡å¹³å°è‡ªåŠ¨é€‰æ‹©ï¼Œä½ å¯ä»¥æ£€æŸ¥ï¼š

```zig
// åœ¨ä»£ç ä¸­éªŒè¯
const is_atomic = @TypeOf(@field(AsyncLogger, "current_file_size")) == std.atomic.Value(u64);
std.debug.print("ä½¿ç”¨åŸå­æ“ä½œ: {}\n", .{is_atomic});

// ç¼–è¯‘è¾“å‡º
// ARMv6: ä½¿ç”¨åŸå­æ“ä½œ: false  âœ…
// x86_64: ä½¿ç”¨åŸå­æ“ä½œ: true âœ…
```

## ğŸ“ æœ€ä½³å®è·µ

### åµŒå…¥å¼è®¾å¤‡å»ºè®®

å¯¹äº ARMv6/ARMv7 ç­‰åµŒå…¥å¼è®¾å¤‡ï¼š

1. **å¯ç”¨é›¶åˆ†é…æ¨¡å¼**
   ```zig
   const config = AsyncLoggerConfig{
       .allocation_strategy = .zero_alloc,
       .queue_capacity = 2048, // æ ¹æ®å†…å­˜è°ƒæ•´
   };
   ```

2. **å‡å°é˜Ÿåˆ—å®¹é‡**ï¼ˆèŠ‚çœå†…å­˜ï¼‰
   ```zig
   .queue_capacity = 1024, // è€Œéé»˜è®¤ 8192
   ```

3. **é™åˆ¶æ—¥å¿—çº§åˆ«**
   ```zig
   .global_level = .info, // è¿‡æ»¤æ‰ debug æ—¥å¿—
   ```

4. **å®šæœŸè½®è½¬**ï¼ˆé¿å…å•æ–‡ä»¶è¿‡å¤§ï¼‰
   ```zig
   .max_file_size = 10 * 1024 * 1024, // 10MB
   ```

### æœåŠ¡å™¨/æ¡Œé¢å»ºè®®

x86_64/AArch64 ç­‰å¹³å°å¯ä»¥å……åˆ†åˆ©ç”¨åŸå­æ“ä½œï¼š

1. **ä½¿ç”¨é»˜è®¤é…ç½®**ï¼ˆå·²ä¼˜åŒ–ï¼‰
   ```zig
   const config = AsyncLoggerConfig.default();
   ```

2. **é«˜åååœºæ™¯**
   ```zig
   .queue_capacity = 16384, // æ›´å¤§é˜Ÿåˆ—
   .batch_size = 200,       // æ‰¹é‡å¤„ç†
   ```

## ğŸ”— ç›¸å…³èµ„æº

- [å¼‚æ­¥æ—¥å¿—ä½¿ç”¨æŒ‡å—](async_logger_usage.md)
- [é›¶åˆ†é…å®ç°åˆ†æ](zero_allocation_implementation.md)
- [Zig ç¼–è¯‘ç›®æ ‡](https://ziglang.org/documentation/master/#Targets)
- [ARM æ¶æ„å‚è€ƒæ‰‹å†Œ](https://developer.arm.com/architectures/cpu-architecture/a-profile/exploration-tools)

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°å¹³å°å…¼å®¹æ€§é—®é¢˜ï¼Œè¯·æäº¤ Issue å¹¶é™„ä¸Šï¼š
- ç›®æ ‡å¹³å°ä¿¡æ¯ï¼ˆ`zig targets`ï¼‰
- ç¼–è¯‘å‘½ä»¤å’Œé”™è¯¯è¾“å‡º
- CPU å‹å·å’Œæ“ä½œç³»ç»Ÿç‰ˆæœ¬

---

**æœ€åæ›´æ–°**: 2025-01-12  
**é€‚ç”¨ç‰ˆæœ¬**: zzig v1.0.0+  
**Zig ç‰ˆæœ¬**: 0.15.2+
